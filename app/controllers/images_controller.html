<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../assets/vendor/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/vendor/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/vendor/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../index.html"><img src="../../assets/images/logo.png" alt="Ruby Critic Logo" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
      
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../index.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
          <li class="sidebar-item">
            <a href="../../simple_cov_index.html" class="project-nav-item coverage-index-nav"><i class="fa fa-umbrella"></i>Coverage</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2024-11-01 18:42:50 -0500'>2024-11-01 18:42:50 -0500</time>
        
      </span>
    </div>
    <div>
      <h3><small>app/controllers /</small> images_controller.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating d big">
              D
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">202</span><small> lines of codes</small></div>
              <div><span class="metric">11</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">22.7</span><small> complexity/method</small></div>
              <div><span class="metric">30</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">249.58</span><small> complexity</small></div>
              <div><span class="metric">0</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                28
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">class ImagesController &lt; ApplicationController<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>ImagesController assumes too much for instance variable '@image'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>ImagesController assumes too much for instance variable '@image_report'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>ImagesController assumes too much for instance variable '@images'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>ImagesController assumes too much for instance variable '@run_time_object'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>ImagesController assumes too much for instance variable '@vulnerability_summary'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>ImagesController has no descriptive comment</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Instance-Variables.md" target="_blank"><b>TooManyInstanceVariables</b></a>        </span>      </div>      <span>ImagesController has at least 9 instance variables</span>          </div>  </li></ol>
  SEVERITY_ORDER = {
  &quot;CRITICAL&quot; =&gt; 1,
  &quot;HIGH&quot; =&gt; 2,
  &quot;MEDIUM&quot; =&gt; 3,
  &quot;LOW&quot; =&gt; 4,
  &quot;UNKNOWN&quot; =&gt; 5
}
  before_action :set_image, only: %i[ show edit update destroy rescan download ]

  # GET /images or /images.json
  def index
    @run_time_object = RunTimeObject.find(params[:run_time_object_id])  # Fetch the RunTimeObject
    @images = @run_time_object.images  # Get images associated with that RunTimeObject
    @pagy, @images = pagy(@images)
  end

  def show<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>ImagesController#show has a flog score of 54</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>ImagesController#show has approx 19 statements</span>          </div>  </li></ol>
    @tag = params[:id]
    @run_time_object = RunTimeObject.find(params[:run_time_object_id])
    @user = current_user
    begin
      @image_report = JSON.parse(@image.report.gsub(/\e\[([;\d]+)?m/, &quot;&quot;).gsub(/\n/, &quot;&quot;).gsub(/[\u0000-\u001F]/, &quot;&quot;))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#show calls '@image.report' 2 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L23" class="js-smell-location">0</a>                  <a href="images_controller.html#L25" class="js-smell-location">1</a>                  </div>  </li></ol>
    rescue JSON::ParserError
      @image_report = { &quot;Results&quot; =&gt; [ { &quot;Target&quot; =&gt; @image.report, &quot;Vulnerabilities&quot; =&gt; [] } ] }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#show calls '@image.report' 2 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L23" class="js-smell-location">0</a>                  <a href="images_controller.html#L25" class="js-smell-location">1</a>                  </div>  </li></ol>
    end

    cve_to_nist_mapping = CveNistMapping.pluck(:cve_id, :nist_control_identifiers).to_h

    @vulnerability_summary = {}
    @fixable_vulnerabilities_count = 0
    @image_report[&quot;Results&quot;].each do |result|
      target = result[&quot;Target&quot;]
      next if result[&quot;Vulnerabilities&quot;].nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#show calls 'result["Vulnerabilities"]' 4 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L34" class="js-smell-location">0</a>                  <a href="images_controller.html#L36" class="js-smell-location">1</a>                  <a href="images_controller.html#L45" class="js-smell-location">2</a>                  <a href="images_controller.html#L46" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>ImagesController#show performs a nil-check</span>          </div>  </li></ol>

      result[&quot;Vulnerabilities&quot;].each do |vuln|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#show calls 'result["Vulnerabilities"]' 4 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L34" class="js-smell-location">0</a>                  <a href="images_controller.html#L36" class="js-smell-location">1</a>                  <a href="images_controller.html#L45" class="js-smell-location">2</a>                  <a href="images_controller.html#L46" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>ImagesController#show contains iterators nested 2 deep</span>              <span>Locations:</span>                  <a href="images_controller.html#L36" class="js-smell-location">0</a>                  <a href="images_controller.html#L45" class="js-smell-location">1</a>                  <a href="images_controller.html#L46" class="js-smell-location">2</a>                  </div>  </li></ol>
        # Add NIST Control Identifiers to each vulnerability
        cve_id = vuln[&quot;VulnerabilityID&quot;]
        vuln[&quot;NISTControlIdentifiers&quot;] = cve_to_nist_mapping[cve_id] || []
        if vuln[&quot;FixedVersion&quot;].present? &amp;&amp; vuln[&quot;FixedVersion&quot;] != &quot;&quot;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#show calls 'vuln["FixedVersion"]' 2 times</span>          </div>  </li></ol>
          @fixable_vulnerabilities_count += 1
        end
      end

      result[&quot;Vulnerabilities&quot;].sort_by! { |vuln| SEVERITY_ORDER[vuln[&quot;Severity&quot;]] || 99 }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#show calls 'result["Vulnerabilities"]' 4 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L34" class="js-smell-location">0</a>                  <a href="images_controller.html#L36" class="js-smell-location">1</a>                  <a href="images_controller.html#L45" class="js-smell-location">2</a>                  <a href="images_controller.html#L46" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>ImagesController#show contains iterators nested 2 deep</span>              <span>Locations:</span>                  <a href="images_controller.html#L36" class="js-smell-location">0</a>                  <a href="images_controller.html#L45" class="js-smell-location">1</a>                  <a href="images_controller.html#L46" class="js-smell-location">2</a>                  </div>  </li></ol>
      @vulnerability_summary[target] = result[&quot;Vulnerabilities&quot;].group_by { |v| v[&quot;Severity&quot;] }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#show calls 'result["Vulnerabilities"]' 4 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L34" class="js-smell-location">0</a>                  <a href="images_controller.html#L36" class="js-smell-location">1</a>                  <a href="images_controller.html#L45" class="js-smell-location">2</a>                  <a href="images_controller.html#L46" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>ImagesController#show contains iterators nested 2 deep</span>              <span>Locations:</span>                  <a href="images_controller.html#L36" class="js-smell-location">0</a>                  <a href="images_controller.html#L45" class="js-smell-location">1</a>                  <a href="images_controller.html#L46" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>ImagesController#show has the variable name 'v'</span>          </div>  </li></ol>
                                                                .transform_values(&amp;:count)
    end
  end


  def new
    @user = current_user
    @run_time_object = RunTimeObject.find(params[:run_time_object_id])
    @image = Image.new
  end

  # GET /images/1/edit
  def edit
    @run_time_object = RunTimeObject.find(params[:run_time_object_id])
    @image = @run_time_object.images.find(params[:id])
  end

  def create<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>ImagesController#create has approx 6 statements</span>          </div>  </li></ol>
    @run_time_object = RunTimeObject.find(params[:run_time_object_id])  # Fetch the parent resource
    @image = @run_time_object.images.new(image_params)  # Associate the image with the parent

    image_name = params[:image][:tag]

    # Perform trivy scan for the image from URL
    @image.report = `json_out=$(trivy image --format json #{image_name}) &amp;&amp; echo $json_out` # Run trivy scan on the provided image name
    # @image.report&amp;.gsub!(/\e\[([;\d]+)?m/, &quot;&quot;)
    # puts @image.report

    if @image.save
      redirect_to run_time_object_image_path(@run_time_object.id, @image), notice: &quot;Image was successfully created.&quot;
    else
      render :new
    end
  end


  def rescan
    image_name = @image.tag
    @run_time_object = RunTimeObject.find(params[:run_time_object_id])
    begin
        @image.report = `json_out=$(trivy image --format json #{image_name}) &amp;&amp; echo $json_out`
        Rails.logger.debug &quot;New Report: #{@image.report}&quot;

        if @image.save
          redirect_to run_time_object_image_path(@run_time_object.id, @image), notice: &quot;Rescan was successful.&quot;
        end
    end
  end

  def download<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>ImagesController#download has a flog score of 102</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>ImagesController#download has approx 22 statements</span>          </div>  </li></ol>
    unless @image.report.present?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#download calls '@image.report' 2 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L97" class="js-smell-location">0</a>                  <a href="images_controller.html#L103" class="js-smell-location">1</a>                  </div>  </li></ol>
      flash[:alert] = &quot;No report available for this image.&quot;
      redirect_to run_time_object_image_path(@image.run_time_object, @image) and return<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#download calls '@image.run_time_object' 2 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L99" class="js-smell-location">0</a>                  <a href="images_controller.html#L106" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#download calls 'redirect_to run_time_object_image_path(@image.run_time_object, @image)' 2 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L99" class="js-smell-location">0</a>                  <a href="images_controller.html#L106" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#download calls 'run_time_object_image_path(@image.run_time_object, @image)' 2 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L99" class="js-smell-location">0</a>                  <a href="images_controller.html#L106" class="js-smell-location">1</a>                  </div>  </li></ol>
    end

    begin
      @image_report = JSON.parse(@image.report.gsub(/\e\[([;\d]+)?m/, &quot;&quot;).gsub(/\n/, &quot;&quot;).gsub(/[\u0000-\u001F]/, &quot;&quot;))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#download calls '@image.report' 2 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L97" class="js-smell-location">0</a>                  <a href="images_controller.html#L103" class="js-smell-location">1</a>                  </div>  </li></ol>
    rescue JSON::ParserError
      flash[:alert] = &quot;Failed to parse the report. Invalid JSON format.&quot;
      redirect_to run_time_object_image_path(@image.run_time_object, @image) and return<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#download calls '@image.run_time_object' 2 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L99" class="js-smell-location">0</a>                  <a href="images_controller.html#L106" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#download calls 'redirect_to run_time_object_image_path(@image.run_time_object, @image)' 2 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L99" class="js-smell-location">0</a>                  <a href="images_controller.html#L106" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#download calls 'run_time_object_image_path(@image.run_time_object, @image)' 2 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L99" class="js-smell-location">0</a>                  <a href="images_controller.html#L106" class="js-smell-location">1</a>                  </div>  </li></ol>
    end

    # Process and generate CSV content
    cve_to_nist_mapping = CveNistMapping.pluck(:cve_id, :nist_control_identifiers).to_h
    vulnerabilities_data = []

    @image_report[&quot;Results&quot;].each do |result|
      target = result[&quot;Target&quot;]
      next if result[&quot;Vulnerabilities&quot;].nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#download calls 'result["Vulnerabilities"]' 2 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L115" class="js-smell-location">0</a>                  <a href="images_controller.html#L117" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>ImagesController#download performs a nil-check</span>          </div>  </li></ol>

      result[&quot;Vulnerabilities&quot;].each do |vuln|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#download calls 'result["Vulnerabilities"]' 2 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L115" class="js-smell-location">0</a>                  <a href="images_controller.html#L117" class="js-smell-location">1</a>                  </div>  </li></ol>
        nist_ids = (cve_to_nist_mapping[vuln[&quot;VulnerabilityID&quot;]] || []).map do |nist_id|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#download calls 'vuln["VulnerabilityID"]' 2 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L118" class="js-smell-location">0</a>                  <a href="images_controller.html#L134" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>ImagesController#download contains iterators nested 3 deep</span>          </div>  </li></ol>
          parts = nist_id.split(&quot;/&quot;)
          if parts.length == 2
            ActionController::Base.helpers.link_to(
              nist_id,
              &quot;https://csf.tools/reference/nist-sp-800-53/r4/#{parts[0].downcase}/#{nist_id.downcase}/&quot;,
              target: &quot;_blank&quot;, class: &quot;nist-link&quot;
            ).to_s
          else
            &quot;&lt;span class=&#39;nist-id&#39;&gt;#{nist_id}&lt;/span&gt;&quot;
          end
        end.join(&quot; &quot;)

        vulnerabilities_data &lt;&lt; {
          title: vuln[&quot;Title&quot;] || &quot;N/A&quot;,
          severity: vuln[&quot;Severity&quot;] || &quot;N/A&quot;,
          id: vuln[&quot;VulnerabilityID&quot;] || &quot;N/A&quot;,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>ImagesController#download calls 'vuln["VulnerabilityID"]' 2 times</span>              <span>Locations:</span>                  <a href="images_controller.html#L118" class="js-smell-location">0</a>                  <a href="images_controller.html#L134" class="js-smell-location">1</a>                  </div>  </li></ol>
          installed_version: vuln[&quot;InstalledVersion&quot;] || &quot;N/A&quot;,
          fixed_version: vuln[&quot;FixedVersion&quot;] || &quot;N/A&quot;,
          status: vuln[&quot;Status&quot;] || &quot;&quot;,
          nist_identifiers: nist_ids,
          description: vuln[&quot;Description&quot;].to_s.gsub(/&lt;\/?[^&gt;]+?&gt;/, &quot;&quot;).strip || &quot;N/A&quot;
        }
      end
    end

    csv_content = CSV.generate(headers: true) do |csv|
      csv &lt;&lt; [ &quot;Title&quot;, &quot;Severity&quot;, &quot;ID&quot;, &quot;Installed Version&quot;, &quot;Fixed Version&quot;, &quot;Status&quot;, &quot;NIST Identifiers&quot;, &quot;Description&quot; ]
      vulnerabilities_data.each do |vuln|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>ImagesController#download contains iterators nested 2 deep</span>          </div>  </li></ol>
        csv &lt;&lt; [
          vuln[:title],
          vuln[:severity],
          vuln[:id],
          vuln[:installed_version],
          vuln[:fixed_version],
          vuln[:status],
          vuln[:nist_identifiers],
          vuln[:description]
        ]
      end
    end

    new_name = @image.tag.gsub(/[^0-9A-Za-z.\-]/, &quot;_&quot;)
    send_data csv_content,
              filename: &quot;vulnerability_report_#{new_name}.csv&quot;,
              type: &quot;text/csv&quot;,
              disposition: &quot;attachment&quot;
  end


  # PATCH/PUT /images/1 or /images/1.json
  def update<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>ImagesController#update has approx 6 statements</span>          </div>  </li></ol>
    @run_time_object = RunTimeObject.find(params[:run_time_object_id])
    @image = @run_time_object.images.find(params[:id])

    if @image.update(image_params)
      image_name = @image.tag
      @image.report = `json_out=$(trivy image --format json #{image_name}) &amp;&amp; echo $json_out`
      @image.save
      redirect_to run_time_object_image_path(@run_time_object.id, @image), notice: &quot;Image was successfully updated.&quot;
    end
  end

  def destroy
    @run_time_object = RunTimeObject.find(params[:run_time_object_id])
    @image = @run_time_object.images.find(params[:id])

    @image.destroy

    redirect_to run_time_object_images_path(@run_time_object), notice: &quot;Image was successfully deleted.&quot;
  end

  private
    # Use callbacks to share common setup or constraints between actions.
    def set_image
      @image = Image.find(params[:id])
      Rails.logger.debug &quot;Image found: #{@image.inspect}&quot;
    end


    # Only allow a list of trusted parameters through.
    def image_params
      params.require(:image).permit(:tag, :run_time_object_id)
    end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- JavaScripts -->
    <script src="../../assets/vendor/javascripts/jquery.min.js"></script>
    <script src="../../assets/vendor/javascripts/jquery.tablesorter.min.js"></script>
    <script src="../../assets/vendor/javascripts/jquery.scrollTo.min.js"></script>
    <script src="../../assets/vendor/javascripts/jquery.timeago.js"></script>
    <script src="../../assets/vendor/javascripts/highcharts.src-4.0.1.js"></script>
    <script src="../../assets/vendor/javascripts/prettify.js"></script>
    <script src="../../assets/vendor/javascripts/bootstrap.min.js"></script>
    <script src="../../assets/javascripts/application.js"></script>
    <script src="../../assets/vendor/javascripts/jquery.filtertable.min.js"></script>
  </body>
</html>
